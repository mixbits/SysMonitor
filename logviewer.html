<!DOCTYPE html>
<html style="height: 100%; overflow: hidden;">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>System Monitor - Log Viewer</title>
        <link rel="icon" href="/favicon.ico" type="image/x-icon">
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon" href="/images/sysmonitor.ico">
        <link rel="icon" href="/images/sysmonitor.ico?v=2" type="image/x-icon">
        <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
        <script>
            let isMobileDevice = false;
            let isTabletDevice = false;
            let deviceOrientation = 'landscape';
            
            function detectDevice() {
                const userAgent = navigator.userAgent.toLowerCase();
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                isMobileDevice = /android|webos|iphone|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
                
                isTabletDevice = /ipad|tablet|playbook|silk/i.test(userAgent) || 
                                 (width >= 768 && width <= 1024);
                
                deviceOrientation = width > height ? 'landscape' : 'portrait';
                
                document.body.classList.remove('desktop-device', 'mobile-device', 'tablet-device', 'landscape-orientation', 'portrait-orientation');
                
                if (isMobileDevice) {
                    document.body.classList.add('mobile-device');
                } else if (isTabletDevice) {
                    document.body.classList.add('tablet-device');
                } else {
                    document.body.classList.add('desktop-device');
                }
                
                document.body.classList.add(deviceOrientation + '-orientation');
                
                console.log(`Device detected: ${isMobileDevice ? 'Mobile' : isTabletDevice ? 'Tablet' : 'Desktop'}, Orientation: ${deviceOrientation}`);
            }
            
            window.addEventListener('resize', function() {
                detectDevice();
            });
            
            window.addEventListener('DOMContentLoaded', function() {
                detectDevice();
            });
        </script>
        <style>
            * {
                -webkit-overflow-scrolling: touch;
                -webkit-tap-highlight-color: rgba(0,0,0,0);
                box-sizing: border-box;
            }
            
            @supports (-webkit-touch-callout: none) {
                body {
                    background-attachment: scroll;
                }
            }
            
            html, body {
                overscroll-behavior: none;
                font-size: 16px;
                background-color: #9d8e81;
                margin: 0 !important;
                padding: 0 !important;
                height: 100% !important; 
                width: 100% !important;
                overflow: hidden !important;
                color: #333;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-image: url('/images/leaves.jpg');
                background-position: center center;
                background-repeat: no-repeat;
                background-size: cover;
                background-attachment: fixed;
                position: relative;
            }
            
            body::before {
                content: "";
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: radial-gradient(
                    ellipse at center,
                    rgba(0, 0, 0, 0) 0%,
                    rgba(0, 0, 0, 0) 50%,
                    rgba(0, 0, 0, 0.5) 100%
                );
                pointer-events: none;
                z-index: 0;
            }
            
            #page-content, .nav-container {
                position: relative;
                z-index: 1;
            }
            
            @media (orientation: portrait) {
                html, body {
                    background-size: auto 100%;
                }
                
                body::before {
                    background: radial-gradient(
                        ellipse at center,
                        rgba(0, 0, 0, 0) 0%,
                        rgba(0, 0, 0, 0) 40%,
                        rgba(0, 0, 0, 0.5) 100%
                    );
                }
            }
            
            @media (orientation: landscape) {
                html, body {
                    background-size: 100% auto;
                }
            }
            
            @media (min-aspect-ratio: 1/1) {
                html, body {
                    background-size: cover;
                }
            }
            
            input, select, textarea {
                font-size: 16px;
            }
            
            button, .nav-button, .SingleDatePickerInput {
                min-height: 44px;
                min-width: 44px;
            }
            
            .CalendarDay__selected, 
            .CalendarDay__selected:hover {
                background: #5c4023 !important;
                color: white !important;
                border: 1px solid #5c4023 !important;
            }
            
            .SingleDatePickerInput {
                background-color: #f2e8dc !important;
                border: 1px solid #ccc !important;
                border-radius: 4px !important;
            }
            
            .DateInput_input {
                background-color: #f2e8dc !important;
                cursor: pointer !important;
            }
            
            h1, h2, h3, h4, h5, h6 {
                color: #5c4023 !important;
                margin-top: 0 !important;
            }
            
            .nav-links {
                display: flex !important;
                margin-left: auto !important;
                padding-left: 10px !important;
            }
            
            .nav-button {
                padding: 8px 16px !important;
                background-color: #8b6b4f !important;
                color: white !important;
                border: none !important;
                border-radius: 6px !important;
                cursor: pointer !important;
                font-size: 14px !important;
                font-weight: 500 !important;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
                text-decoration: none !important;
                display: inline-block !important;
                text-align: center !important;
                min-height: 30px !important;
                transition: all 0.2s ease-in-out !important;
            }
            
            .nav-button:hover {
                background-color: #a17d5d !important;
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3) !important;
            }
            
            .nav-button:active {
                background-color: #6a5339 !important;
                box-shadow: 0 1px 4px rgba(0, 0, 0, 0.4) inset !important;
                transform: translateY(1px) !important;
            }
            
            .app-title {
                display: inline-block !important;
                font-size: 20px !important;
                color: #000000 !important;
                text-shadow: none !important;
                text-align: center !important;
                margin: 0 auto !important;
                font-weight: bold !important;
            }
            
            @media screen and (max-width: 768px) {
                .nav-container {
                    flex-direction: row !important;
                    align-items: center !important;
                    padding: 8px 15px !important;
                    height: auto !important;
                }
                
                h1, .app-title {
                    font-size: 18px !important;
                    margin: 0 auto !important;
                }
                
                .graph-container {
                    width: 100% !important;
                    height: auto !important;
                }
                
                .CalendarMonth {
                    padding: 0 !important;
                }
                
                .CalendarDay {
                    padding: 0 !important;
                    font-size: 14px !important;
                }
                
                .container {
                    padding: 5px !important;
                    margin-top: 5px !important;
                }
            }
            
            @media screen and (max-width: 480px) {
                h1, .app-title {
                    font-size: 16px !important;
                    max-width: 60% !important;
                }
                
                .nav-button {
                    width: auto !important;
                    margin-top: 0 !important;
                    padding: 4px 10px !important;
                    font-size: 12px !important;
                }
                
                .date-picker-container {
                    max-width: 100% !important;
                }
            }
            
            @media screen and (max-height: 500px) and (orientation: landscape) {
                .container {
                    min-height: auto !important;
                }
                
                .graph-container {
                    height: 180px !important;
                }
            }

            .container {
                width: 100% !important;
                padding: 5px 15px 2px 15px !important;
                box-sizing: border-box !important;
                background-color: transparent !important;
                border-radius: 10px !important;
                box-shadow: none !important;
                margin-top: 5px !important;
                height: calc(100vh - 55px) !important;
                overflow: hidden !important;
                position: relative !important;
            }
            
            .graph-wrapper {
                width: 100% !important;
                margin: 0 !important;
                background-color: #f2e8dc !important;
                border-radius: 8px !important;
                padding: 3px !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
                transition: none !important;
                flex: 1 !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden !important;
            }
            
            .log-viewer-container {
                display: flex !important;
                flex-direction: column !important;
                width: 100% !important;
                height: calc(100vh - 80px) !important;
                overflow: hidden !important;
                padding: 15px !important;
                margin: 0 !important;
                box-sizing: border-box !important;
            }
            
            .date-picker-container {
                width: 100% !important;
                box-sizing: border-box !important;
                background-color: rgba(242, 232, 220, 0.95) !important;
                border-radius: 8px !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
                padding: 8px 15px !important;
                margin: 0 !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            #log-graphs-container {
                flex: 1 !important;
                margin-top: 10px !important;
                max-height: calc(100vh - 170px) !important;
                min-height: 500px !important;
                margin-bottom: 0 !important;
                width: 100% !important;
                overflow: visible !important;
                position: relative !important;
                box-sizing: border-box !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: stretch !important;
                align-items: stretch !important;
                background-color: rgba(242, 232, 220, 0.95) !important;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4) !important;
            }
            
            #historical-graph {
                flex: 1 !important;
                min-height: 500px !important;
                width: 100% !important;
                height: calc(100% - 10px) !important;
            }
            
            .nav-container {
                width: 100% !important;
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                background-color: #6B4423 !important;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2) !important;
                border: none !important;
                border-bottom: 4px solid #4D3018 !important;
                padding: 4px 20px !important;
                height: 45px !important;
                box-sizing: border-box !important;
                z-index: 1000 !important;
            }
            
            .CalendarDay__default {
                background-color: #f2e8dc !important;
                color: #333 !important;
                border: 1px solid #d8d8d8 !important;
                font-weight: normal !important;
            }
            
            .CalendarDay:not([aria-disabled="true"]):not(.CalendarDay__selected) {
                font-weight: bold !important;
                color: #5c4023 !important;
            }
            
            .CalendarDay__selected, 
            .CalendarDay__selected:hover {
                background-color: #5c4023 !important;
                color: #fff !important;
                border: 1px solid #5c4023 !important;
                font-weight: normal !important;
            }
            
            .spinner-border {
                display: inline-block;
                width: 3rem;
                height: 3rem;
                vertical-align: text-bottom;
                border: 0.3em solid black;
                border-right-color: transparent;
                border-radius: 50%;
                animation: spinner-border 0.75s linear infinite;
                box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            }
            
            @keyframes spinner-border {
                to { transform: rotate(360deg); }
            }
            
            .graph-loading-overlay {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background-color: rgba(242, 232, 220, 0.85) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 1000 !important;
                border-radius: 8px !important;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            }
            
            .graph-loading-overlay.loading {
                opacity: 1 !important;
                visibility: visible !important;
            }
            
            .historical-spinner {
                pointer-events: none;
            }
            
            #historical-graph-loading.loading {
                display: flex !important;
            }
            
            #historical-graph-loading:not(.loading) {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
            }
            
            #historical-graph-loading:not(.loading) .spinner-border {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
            }
            
            .js-plotly-plot .legend rect.bg {
                fill: rgba(0, 0, 0, 0) !important;
                stroke: rgba(0, 0, 0, 0) !important;
            }
            
            .date-input-container {
                display: inline-block;
                position: relative;
                background: #f7f2eb;
                border: 1px solid #ccc;
                border-radius: 4px;
                padding: 0;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                overflow: hidden;
                min-width: 150px;
                height: 38px;
            }

            .date-label {
                font-weight: bold;
                margin-right: 10px;
                color: #5c4023;
                display: inline-block;
                min-width: 95px;
            }

            #log-date-input {
                padding: 6px 10px;
                border: none;
                outline: none;
                background: transparent;
                font-size: 16px;
                color: #5c4023;
                cursor: pointer;
                font-weight: 500;
                min-width: 140px;
                width: 100%;
                height: 36px;
            }

            #log-date-input::-webkit-calendar-picker-indicator {
                font-size: 16px;
                cursor: pointer;
                opacity: 0.8;
            }

            .clear-date-btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 20px;
                height: 20px;
                position: absolute;
                right: 30px;
                top: 8px;
                background: #dbd3ca;
                border-radius: 50%;
                border: 1px solid #ccc;
                color: #5c4023;
                font-size: 14px;
                line-height: 1;
                cursor: pointer;
                opacity: 0.7;
                transition: opacity 0.2s;
                z-index: 10;
            }

            .clear-date-btn:hover {
                opacity: 1;
            }

            .record-count {
                font-weight: bold;
                color: #5c4023;
                font-size: 20px;
                text-align: center;
                margin: 0 auto;
            }

            .calendar-popup {
                width: 300px;
                background-color: #f2e8dc;
                border: 2px solid #8b6b4f;
                border-radius: 8px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                padding: 15px;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 10000;
            }

            .calendar-month-year {
                font-weight: bold;
                font-size: 16px;
                text-align: center;
                color: #5c4023;
                margin-bottom: 10px;
            }

            .calendar-nav-btn {
                background-color: #d9c2a7;
                border: 1px solid #b89c7d;
                border-radius: 4px;
                color: #5c4023;
                cursor: pointer;
                font-size: 18px;
                padding: 2px 8px;
                transition: background-color 0.2s;
            }

            .calendar-nav-btn:hover {
                background-color: #b89c7d;
            }

            .calendar-day {
                text-align: center;
                padding: 6px;
                border-radius: 4px;
                font-size: 14px;
            }

            .calendar-day.selectable {
                background-color: #e6d5c0;
                cursor: pointer;
                color: #5c4023;
            }

            .calendar-day.selectable:hover {
                background-color: #d9c2a7;
            }

            .calendar-day.today {
                border: 2px solid #8b6b4f;
            }

            .calendar-day.selected {
                background-color: #8b6b4f;
                color: white;
            }

            .custom-date-input {
                display: flex;
                align-items: center;
                background-color: #cbbeae;
                border: none;
                border-radius: 6px;
                padding: 8px 10px;
                cursor: pointer;
                width: 100%;
                height: 40px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                transition: all 0.2s ease-in-out;
                text-align: center;
                color: #5c4023;
                font-weight: 500;
            }

            .custom-date-input:hover {
                background-color: #d7cabb; /* Lighter on hover */
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            }

            .custom-date-input:active {
                background-color: #bfb2a2; /* Darker when clicked */
                box-shadow: 0 1px 4px rgba(0, 0, 0, 0.4) inset;
                transform: translateY(1px);
            }

            .date-display {
                flex-grow: 1;
                text-align: center;
                font-size: 16px;
                color: #5c4023;
            }

            body.calendar-open::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 9998;
            }

            .calendar-day.selectable {
                font-weight: bold;
                cursor: pointer;
                background-color: #e6d5c0;
            }
            .calendar-day.selectable:hover {
                background-color: #d9c2a7;
            }
            .calendar-day.today {
                border: 2px solid #8b6b4f;
                box-sizing: border-box;
            }
            .calendar-day.selected {
                background-color: #8b6b4f;
                color: white;
                font-weight: bold;
            }
            .today-btn {
                min-width: 70px;
                background-color: #8b6b4f;
                color: #fff;
            }
            .today-btn:hover {
                background-color: #a17d5d;
            }

            /* Modify layout for date picker container and info */
            .date-picker-container {
                width: 100% !important;
                box-sizing: border-box !important;
                background-color: rgba(242, 232, 220, 0.95) !important;
                border-radius: 8px !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
                padding: 8px 15px !important;
                margin: 0 !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            /* Update for proper center alignment */
            #selected-date-info {
                position: absolute;
                left: 0;
                right: 0;
                text-align: center;
                margin: 0 auto;
                pointer-events: none;
                z-index: 5;
            }

            /* Base styles apply to all devices */
            .container {
                width: 100% !important;
                padding: 5px 15px 2px 15px !important;
                box-sizing: border-box !important;
                background-color: transparent !important;
                border-radius: 10px !important;
                box-shadow: none !important;
                margin-top: 5px !important;
                height: calc(100vh - 55px) !important;
                overflow: hidden !important;
                position: relative !important;
            }
            
            /* Device-specific styles */
            
            /* Mobile-specific styles */
            .mobile-device .app-title {
                font-size: 16px !important;
                white-space: normal !important;
                line-height: 1.2 !important;
            }
            
            .mobile-device.portrait-orientation .log-viewer-container {
                padding: 8px !important;
            }
            
            .mobile-device.portrait-orientation .date-picker-container {
                flex-direction: column !important;
                padding: 5px !important;
            }
            
            .mobile-device.portrait-orientation #log-date-picker-container {
                width: 100% !important;
                max-width: none !important;
                margin-bottom: 8px !important;
            }
            
            .mobile-device.portrait-orientation #selected-date-info {
                position: static !important;
                margin-top: 5px !important;
                text-align: center !important;
                width: 100% !important;
            }
            
            .mobile-device.portrait-orientation #historical-graph {
                height: calc(100vh - 170px) !important;
                min-height: 300px !important;
            }
            
            .mobile-device.landscape-orientation #historical-graph {
                height: calc(100vh - 140px) !important;
                min-height: 200px !important;
            }
            
            /* Tablet-specific styles */
            .tablet-device .app-title {
                font-size: 18px !important;
            }
            
            .tablet-device.portrait-orientation #historical-graph {
                height: calc(100vh - 180px) !important;
                min-height: 500px !important;
            }

            /* Additional mobile optimizations for the Plotly graph */
            .mobile-device .graph-container {
                touch-action: pan-x pan-y !important;
            }
            
            .mobile-device .custom-date-input {
                height: 48px !important; /* Larger touch target */
                font-size: 16px !important; /* Prevent iOS zoom on focus */
            }
            
            .mobile-device .date-display {
                font-size: 16px !important;
                font-weight: 500 !important;
            }
            
            /* Ensure the mode bar is usable on mobile */
            .mobile-device .modebar {
                transform: scale(1.2) !important;
                transform-origin: top right !important;
            }
            
            /* Enhance calendar for mobile */
            .mobile-device .calendar-popup {
                width: 90% !important;
                max-width: 320px !important;
                padding: 10px !important;
            }
            
            .mobile-device .calendar-day {
                min-width: 36px !important;
                min-height: 36px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            .mobile-device.portrait-orientation .nav-container {
                padding: 4px 10px !important;
            }
            
            .mobile-device.portrait-orientation .nav-button {
                padding: 6px 12px !important;
            }
            
        </style>
        <script>
            function getPlotlyConfig(isDesktop, isMobile, isTablet) {
                const baseConfig = {
                    displayModeBar: true,
                    responsive: true,
                    modeBarButtonsToRemove: ['autoScale2d'],
                    displaylogo: false,
                    doubleClick: 'reset+autosize'
                };
                
                if (isMobile) {
                    baseConfig.displayModeBar = true;
                    baseConfig.modeBarButtonsToRemove = ['autoScale2d', 'select2d', 'lasso2d', 'hoverClosestCartesian', 'hoverCompareCartesian'];
                    baseConfig.scrollZoom = false;
                }
                
                return baseConfig;
            }
        </script>
    </head>
    <body>
        <div id="react-entry-point">
            <div id="app-container">
                <div class="nav-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div id="nav-buttons-container" style="flex: 1;">
                            <a href="/" class="nav-button">Dashboard</a>
                        </div>
                        
                        <h1 class="app-title" style="flex: 2; text-align: center; margin: 0 auto; font-weight: 900; color: #000000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            System Monitor (host machine name)
                        </h1>
                        
                        <div style="flex: 1;"></div>
                    </div>
                </div>
                
                <div id="page-content" class="container">
                    <div id="log-viewer-layout" class="log-viewer-container">
                        <div class="date-picker-container" style="padding: 8px 15px; background-color: #f2e8dc; border-radius: 8px; width: 100%; max-width: none; box-sizing: border-box; margin: 0; position: relative;">
                            <div style="display: flex; flex-wrap: wrap; align-items: center; width: 100%;">
                                <div style="display: flex; align-items: center; flex-shrink: 0; min-width: 300px;">
                                    <div id="log-date-picker-container" style="font-size: 16px; display: inline-block; cursor: pointer; position: relative;" class="date-input-container">
                                        <div class="custom-date-input">
                                            <div class="date-display">Select Date</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="selected-date-info" style="font-weight: bold; display: flex; justify-content: center; align-items: center;"></div>
                                
                                <div style="flex-shrink: 0; min-width: 300px; visibility: hidden;"></div>
                            </div>
                        </div>
                        
                        <div id="log-graphs-container" class="graph-wrapper" style="margin-top: 10px; height: calc(100vh - 150px); min-height: 650px; display: flex; flex-direction: column; position: relative;">
                            <div id="historical-graph-loading" class="graph-loading-overlay loading" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(242, 232, 220, 0.85) !important; display: flex; justify-content: center; align-items: center; z-index: 1000; border-radius: 8px;">
                                <div class="spinner-border" style="color: black;"></div>
                            </div>
                            
                            <div id="historical-graph" class="graph-container" style="height: 650px; min-height: 650px; width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Required Scripts -->
        <script>
            let selectedDate = null;
            let calendarContainer = null;
            let calendarPopup = null;
            let availableDates = [];
            let calendarVisible = false;
            
            function applyDeviceSpecificOptimizations() {
                const graphContainer = document.getElementById('historical-graph');
                const datePicker = document.getElementById('log-date-picker-container');
                const selectedDateInfo = document.getElementById('selected-date-info');
                
                if (isMobileDevice) {
                    console.log("Applying mobile optimizations");
                    if (graphContainer) {
                        graphContainer.style.webkitOverflowScrolling = 'touch';
                    }
                    
                    if (deviceOrientation === 'portrait') {
                        console.log("Applying mobile portrait layout");
                        if (selectedDateInfo) {
                            selectedDateInfo.style.fontSize = '14px';
                        }
                    } else {
                        console.log("Applying mobile landscape layout");
                    }
                } else if (isTabletDevice) {
                    console.log("Applying tablet optimizations");
                } else {
                    console.log("Applying desktop optimizations");
                }
            }
            
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    detectDevice();
                    applyDeviceSpecificOptimizations();
                    
                    const graphElement = document.getElementById('historical-graph');
                    if (graphElement && graphElement._fullLayout) {
                        console.log("Updating graph layout for new orientation");
                        
                        const updateLayout = {
                            legend: {
                                orientation: isMobileDevice && deviceOrientation === 'portrait' ? 'h' : 'v',
                                x: isMobileDevice && deviceOrientation === 'portrait' ? 0.5 : 1.05,
                                y: isMobileDevice && deviceOrientation === 'portrait' ? -0.2 : 1,
                                xanchor: isMobileDevice && deviceOrientation === 'portrait' ? 'center' : 'left',
                                yanchor: isMobileDevice && deviceOrientation === 'portrait' ? 'top' : 'auto'
                            }
                        };
                        
                        Plotly.relayout(graphElement, updateLayout);
                    }
                }, 300);
            });
            
            function initializeDatePicker() {
                console.log('Initializing calendar and date picker');
                
                const styleEl = document.createElement('style');
                styleEl.textContent = `
                    .js-plotly-plot .plotbg {
                        fill: rgba(242,232,220,0.8) !important;
                    }
                    .js-plotly-plot .main-svg {
                        background-color: rgba(0,0,0,0) !important;
                    }
                    .js-plotly-plot .plot-container {
                        background-color: rgba(0,0,0,0) !important;
                    }
                    .js-plotly-plot .legend rect.bg {
                        fill: rgba(0, 0, 0, 0) !important;
                        stroke: rgba(0, 0, 0, 0) !important;
                    }
                    .js-plotly-plot .legend text {
                        fill: #5c4023 !important;
                    }
                    .js-plotly-plot .legend path.legendtoggle {
                        fill-opacity: 0 !important;
                    }
                `;
                document.head.appendChild(styleEl);
                
                createDatePicker();
            }
            
            document.addEventListener('DOMContentLoaded', function() {
                detectDevice();
                
                applyDeviceSpecificOptimizations();
                
                initializeDatePicker();
                
                fetchAvailableDates().then(dates => {
                    availableDates = dates;
                    console.log(`Fetched ${dates.length} available dates`);
                    
                    if (dates && dates.length > 0) {
                        const mostRecentDate = dates[dates.length - 1];
                        console.log(`Loading most recent date: ${mostRecentDate}`);
                        selectedDate = mostRecentDate;
                        
                        loadHistoricalData(mostRecentDate);
                    } else {
                        console.warn('No available dates found');
                        
                        createHistoricalGraph({
                            time: [],
                            cpu: [],
                            ram: [],
                            net: [],
                            gpu0: [],
                            gpu1: [],
                            gpu2: []
                        }, null, true);
                        
                        const historicalGraphOverlay = document.getElementById('historical-graph-loading');
                        if (historicalGraphOverlay) {
                            historicalGraphOverlay.classList.remove('loading');
                        }
                    }
                }).catch(error => {
                    console.error('Error fetching available dates:', error);
                    
                    const historicalGraphOverlay = document.getElementById('historical-graph-loading');
                    if (historicalGraphOverlay) {
                        historicalGraphOverlay.classList.remove('loading');
                    }
                    
                    createHistoricalGraph({
                        time: [],
                        cpu: [],
                        ram: [],
                        net: [],
                        gpu0: [],
                        gpu1: [],
                        gpu2: []
                    }, '', true);
                });
            });

            function showCalendar() {
                if (calendarPopup) {
                    console.log('Showing calendar popup');
                    calendarVisible = true;
                    calendarPopup.style.display = 'block';
                    calendarPopup.style.top = '50%';
                    calendarPopup.style.left = '50%';
                    calendarPopup.style.transform = 'translate(-50%, -50%)';
                    document.body.classList.add('calendar-open');
                } else {
                    console.error('Calendar popup element not found');
                }
            }

            function hideCalendar() {
                if (calendarPopup) {
                    console.log('Hiding calendar popup');
                    calendarVisible = false;
                    calendarPopup.style.display = 'none';
                    document.body.classList.remove('calendar-open');
                } else {
                    console.error('Calendar popup element not found');
                }
            }

            function createDatePicker() {
                console.log('Initializing date picker');
                const datePickerContainer = document.getElementById('log-date-picker-container');
                if (!datePickerContainer) {
                    console.error('Date picker container not found');
                    return;
                }
                
                const customDateInput = datePickerContainer.querySelector('.custom-date-input');
                const dateDisplay = datePickerContainer.querySelector('.date-display');
                
                if (!customDateInput || !dateDisplay) {
                    console.error('Date picker elements not found');
                    return;
                }
                
                customDateInput.addEventListener('click', async function(event) {
                    event.stopPropagation();
                    console.log('Date input clicked, toggling calendar');
                    
                    if (calendarVisible) {
                        hideCalendar();
                    } else {
                        try {
                            const dates = await fetchAvailableDates();
                            if (dates && dates.length > 0) {
                                availableDates = dates;
                                console.log(`Refreshed available dates: ${availableDates.join(', ')}`);
                                
                                const monthYearSpan = document.querySelector('.calendar-month-year-span');
                                if (monthYearSpan) {
                                    const currentMonthYear = monthYearSpan.textContent.split(' ');
                                    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                                    const month = months.indexOf(currentMonthYear[0]);
                                    const year = parseInt(currentMonthYear[1]);
                                    renderCalendar(month, year);
                                }
                            }
                        } catch (error) {
                            console.error('Error refreshing available dates:', error);
                        }
                        
                        showCalendar();
                    }
                });
                
                if (!calendarPopup) {
                calendarPopup = document.createElement('div');
                calendarPopup.className = 'calendar-popup';
                calendarPopup.style.display = 'none';
                
                const navRow = document.createElement('div');
                navRow.style.display = 'flex';
                navRow.style.justifyContent = 'space-between';
                navRow.style.marginBottom = '10px';
                
                const prevBtn = document.createElement('button');
                prevBtn.className = 'calendar-nav-btn';
                prevBtn.textContent = '←';
                prevBtn.addEventListener('click', function(event) {
                    event.stopPropagation();
                    navigateMonth(-1);
                });
                
                const nextBtn = document.createElement('button');
                nextBtn.className = 'calendar-nav-btn';
                nextBtn.textContent = '→';
                nextBtn.addEventListener('click', function(event) {
                    event.stopPropagation();
                    navigateMonth(1);
                });
                
                navRow.appendChild(prevBtn);
                    
                const monthYearSpan = document.createElement('span');
                monthYearSpan.style.fontWeight = 'bold';
                monthYearSpan.style.fontSize = '16px';
                    monthYearSpan.style.color = '#5c4023';
                monthYearSpan.className = 'calendar-month-year-span';
                navRow.appendChild(monthYearSpan);
                navRow.appendChild(nextBtn);
                
                calendarPopup.appendChild(navRow);
                
                calendarContainer = document.createElement('div');
                calendarContainer.style.display = 'grid';
                calendarContainer.style.gridTemplateColumns = 'repeat(7, 1fr)';
                calendarContainer.style.gap = '5px';
                
                const dayNames = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
                dayNames.forEach(day => {
                    const dayNameElement = document.createElement('div');
                    dayNameElement.className = 'calendar-day-name';
                    dayNameElement.textContent = day;
                    dayNameElement.style.textAlign = 'center';
                    dayNameElement.style.fontWeight = 'bold';
                    calendarContainer.appendChild(dayNameElement);
                });
                
                calendarPopup.appendChild(calendarContainer);
                document.body.appendChild(calendarPopup);
                
                const currentDate = new Date();
                
                fetchAvailableDates().then(dates => {
                    if (dates && dates.length > 0) {
                        availableDates = dates;
                        console.log(`Initialized calendar with available dates: ${availableDates.join(', ')}`);
                    }
                    renderCalendar(currentDate.getMonth(), currentDate.getFullYear());
                }).catch(error => {
                    console.error('Error fetching available dates for calendar initialization:', error);
                    renderCalendar(currentDate.getMonth(), currentDate.getFullYear());
                });
                
                document.addEventListener('click', function(event) {
                    if (calendarVisible && !calendarPopup.contains(event.target) && !customDateInput.contains(event.target)) {
                        hideCalendar();
                    }
                });
                }
                
                console.log('Date picker initialized successfully');
            }

            function navigateMonth(direction) {
                const monthYearSpan = document.querySelector('.calendar-month-year-span');
                if (!monthYearSpan) return;
                
                const currentMonthYear = monthYearSpan.textContent.split(' ');
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                
                let month = months.indexOf(currentMonthYear[0]);
                let year = parseInt(currentMonthYear[1]);
                
                month += direction;
                if (month < 0) {
                    month = 11;
                    year--;
                } else if (month > 11) {
                    month = 0;
                    year++;
                }
                
                renderCalendar(month, year);
            }

            function renderCalendar(month, year) {
                const calendarContainer = document.querySelector('.calendar-popup > div:last-child');
                const monthYearSpan = document.querySelector('.calendar-month-year-span');
                
                if (!calendarContainer) {
                    console.error('Calendar container not found');
                    return;
                }
                
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                
                if (monthYearSpan) {
                    monthYearSpan.textContent = `${months[month]} ${year}`;
                }
                
                const dayNames = document.querySelectorAll('.calendar-day-name');
                Array.from(calendarContainer.children).forEach(child => {
                    if (!Array.from(dayNames).includes(child)) {
                        calendarContainer.removeChild(child);
                    }
                });
                
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                for (let i = 0; i < firstDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day';
                    calendarContainer.appendChild(emptyDay);
                }
                
                const today = new Date();
                const currentDay = today.getDate();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateElement = document.createElement('div');
                    dateElement.className = 'calendar-day';
                    dateElement.textContent = day;
                    
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isAvailable = availableDates.includes(dateStr);
                    const isToday = day === currentDay && month === currentMonth && year === currentYear;
                    const isSelected = selectedDate === dateStr;
                    
                    if (isAvailable) {
                        dateElement.classList.add('selectable');
                        dateElement.style.fontWeight = 'bold';
                        dateElement.style.cursor = 'pointer';
                        dateElement.style.backgroundColor = '#e6d5c0';
                        
                        dateElement.addEventListener('click', function(event) {
                            event.stopPropagation();
                            selectDate(dateStr);
                        });
                        
                        dateElement.addEventListener('mouseover', function() {
                            if (!isSelected) {
                                this.style.backgroundColor = '#d9c2a7';
                            }
                        });
                        
                        dateElement.addEventListener('mouseout', function() {
                            if (!isSelected) {
                                this.style.backgroundColor = '#e6d5c0';
                            }
                        });
                    }
                    
                    if (isToday) {
                        dateElement.classList.add('today');
                        dateElement.style.border = '2px solid #8b6b4f';
                        dateElement.style.boxSizing = 'border-box';
                        
                        if (!isAvailable) {
                            const todayStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
                            
                            dateElement.style.backgroundColor = '#d9c2a7';
                            dateElement.style.cursor = 'pointer';
                            dateElement.style.fontWeight = 'bold';
                            dateElement.style.color = '#5c4023';
                            
                            dateElement.title = "Today - Click to load today's log";
                            
                            dateElement.addEventListener('click', function(event) {
                                event.stopPropagation();
                                const todayStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
                                selectDate(todayStr);
                                hideCalendar();
                            });
                            
                            dateElement.addEventListener('mouseover', function() {
                                this.style.backgroundColor = '#b89c7d';
                            });
                            
                            dateElement.addEventListener('mouseout', function() {
                                this.style.backgroundColor = '#d9c2a7';
                            });
                        }
                    }
                    
                    if (isSelected) {
                        dateElement.classList.add('selected');
                        dateElement.style.backgroundColor = '#8b6b4f';
                        dateElement.style.color = 'white';
                        dateElement.style.fontWeight = 'bold';
                    }
                    
                    calendarContainer.appendChild(dateElement);
                }
            }

            function selectDate(dateStr) {
                console.log('Date selected:', dateStr);
                selectedDate = dateStr;
                
                const dateDisplay = document.querySelector('.date-display');
                if (dateDisplay) {
                    dateDisplay.textContent = 'Select Date';
                }
                
                loadHistoricalData(dateStr);
                hideCalendar();
                
                const monthYearSpan = document.querySelector('.calendar-month-year-span');
                if (monthYearSpan) {
                    const currentMonthYear = monthYearSpan.textContent.split(' ');
                    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                    const month = months.indexOf(currentMonthYear[0]);
                    const year = parseInt(currentMonthYear[1]);
                    renderCalendar(month, year);
                }
            }

            async function fetchAvailableDates() {
                try {
                    console.log('Fetching available log dates from server');
                    const response = await fetch('/api/available-dates');
                    
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    
                    const dates = await response.json();
                    console.log(`Received ${dates.length} available dates:`, dates);
                    return dates;
                } catch (error) {
                    console.error('Error fetching available dates:', error);
                    return [];
                }
            }
            
            async function loadHistoricalData(dateStr) {
                try {
                    console.log(`Loading historical data for date: ${dateStr}`);
                    
                    const historicalGraphOverlay = document.getElementById('historical-graph-loading');
                    if (historicalGraphOverlay) {
                        historicalGraphOverlay.classList.add('loading');
                    }
                    
                    const today = new Date();
                    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    const isRequestingToday = dateStr === todayStr;
                    
                    const response = await fetch(`/api/log-data/${dateStr}`);
                    
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    const recordCount = data.time ? data.time.length : 0;
                    updateSelectedDateInfo(dateStr, recordCount);
                    
                    createHistoricalGraph(data, dateStr);
                    
                    console.log(`Loaded ${recordCount} records for ${dateStr}`);
                    
                    if (isRequestingToday && recordCount > 0 && !availableDates.includes(todayStr)) {
                        availableDates.push(todayStr);
                        availableDates.sort();
                    }
                    
                    if (historicalGraphOverlay) {
                        historicalGraphOverlay.classList.remove('loading');
                    }
                    
                    return data;
                } catch (error) {
                    console.error(`Error loading data for date ${dateStr}:`, error);
                    
                    const historicalGraphOverlay = document.getElementById('historical-graph-loading');
                    if (historicalGraphOverlay) {
                        historicalGraphOverlay.classList.remove('loading');
                    }
                    
                    updateSelectedDateInfo(dateStr, 0, error.message);
                    
                    createHistoricalGraph({
                        time: [],
                        cpu: [],
                        ram: [],
                        net: [],
                        gpu0: [],
                        gpu1: [],
                        gpu2: []
                    }, dateStr, true);
                    
                    return null;
                }
            }
            
            function updateSelectedDateInfo(dateStr, recordCount, errorMessage = null) {
                const infoElement = document.getElementById('selected-date-info');
                if (!infoElement) return;
                
                if (errorMessage) {
                    infoElement.innerHTML = `<span class="record-count" style="color: #cc0000;">${errorMessage}</span>`;
                    return;
                }
                
                const displayDate = formatDateForDisplay(dateStr);
                
                let infoText = '';
                if (recordCount > 0) {
                    infoText = `<span class="record-count">${recordCount} records found in log graph</span>`;
                } else {
                    infoText = `<span class="record-count">${displayDate} - No data available</span>`;
                }
                
                infoElement.innerHTML = infoText;
            }
            
            function formatDateForDisplay(dateStr) {
                if (!dateStr) return 'No date selected';
                
                try {
                    const dateParts = dateStr.split('-');
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1;
                    const day = parseInt(dateParts[2]);
                    
                    const date = new Date(year, month, day);
                    
                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                    return date.toLocaleDateString('en-US', options);
                } catch (error) {
                    console.error('Error formatting date:', error);
                    return dateStr;
                }
            }
            
            function formatDateWithOrdinal(dateStr) {
                if (!dateStr) return 'No date selected';
                
                try {
                    const dateParts = dateStr.split('-');
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1;
                    const day = parseInt(dateParts[2]);
                    
                    const date = new Date(year, month, day);
                    
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                      'July', 'August', 'September', 'October', 'November', 'December'];
                    
                    let suffix = "th";
                    if (day % 10 === 1 && day !== 11) {
                        suffix = "st";
                    } else if (day % 10 === 2 && day !== 12) {
                        suffix = "nd";
                    } else if (day % 10 === 3 && day !== 13) {
                        suffix = "rd";
                    }
                    
                    return `${monthNames[month]} ${day}${suffix} ${year}`;
                } catch (error) {
                    console.error('Error formatting date with ordinal:', error);
                    return dateStr;
                }
            }
            
            function createHistoricalGraph(data, dateStr, isEmpty = false) {
                const graphElement = document.getElementById('historical-graph');
                if (!graphElement) {
                    console.error('Historical graph element not found');
                    return;
                }
                
                let titleFontSize = 16;
                let axisFontSize = 14;
                let legendFontSize = 12;
                let marginLeft = 50;
                let marginBottom = 50;
                
                if (isMobileDevice) {
                    titleFontSize = 14;
                    axisFontSize = 12;
                    legendFontSize = 10;
                    marginLeft = 40;
                    marginBottom = 40;
                    
                    if (deviceOrientation === 'portrait') {
                        marginLeft = 35;
                        marginBottom = 35;
                    }
                }
                
                const graphTitle = isEmpty 
                    ? 'No Data Available' 
                    : (dateStr ? `<b>System performance log for ${formatDateWithOrdinal(dateStr)}</b>` : '<b>System Metrics</b>');
                
                const traces = [];
                
                if (data.time && data.time.length > 0) {
                    traces.push({
                        x: data.time,
                        y: data.cpu,
                        name: 'CPU (%)',
                        line: { color: '#1f77b4', width: 2 }
                    });
                    
                    traces.push({
                        x: data.time,
                        y: data.ram,
                        name: 'RAM (%)',
                        line: { color: '#ff7f0e', width: 2 }
                    });
                    
                    traces.push({
                        x: data.time,
                        y: data.net,
                        name: 'NET (%)',
                        line: { color: '#2ca02c', width: 2 }
                    });
                    
                    traces.push({
                        x: data.time,
                        y: data.gpu0,
                        name: 'GPU0 (%)',
                        line: { color: '#d62728', width: 2 }
                    });
                    
                        traces.push({
                            x: data.time,
                        y: data.gpu1 || Array(data.time.length).fill(0),
                        name: 'GPU1 (%)',
                        line: { color: '#9467bd', width: 2 }
                    });
                    
                        traces.push({
                            x: data.time,
                        y: data.gpu2 || Array(data.time.length).fill(0),
                        name: 'GPU2 (%)',
                        line: { color: '#8c564b', width: 2 }
                    });
                } else if (isEmpty) {
                    traces.push({
                        x: [0],
                        y: [0],
                        text: ['No data available for the selected date'],
                        mode: 'text'
                    });
                }
                
                const layout = {
                    title: graphTitle,
                    xaxis: {
                    title: {
                            text: 'Time',
                            font: {
                                size: axisFontSize,
                                color: '#5c4023'
                            },
                            standoff: 10
                        },
                        showgrid: true,
                        gridcolor: '#e1d5c9',
                        tickformat: '%I:%M %p', 
                        fixedrange: false
                    },
                    yaxis: {
                        title: {
                            text: 'Percentage',
                            font: {
                                size: axisFontSize,
                                color: '#5c4023'
                            }
                        },
                        range: [0, 100],
                        showgrid: true,
                        gridcolor: '#e1d5c9',
                        fixedrange: true
                    },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(242,232,220,0.8)',
                    margin: {
                        l: marginLeft,
                        r: 20,
                        b: marginBottom,
                        t: 50
                    },
                    legend: {
                        orientation: isMobileDevice && deviceOrientation === 'portrait' ? 'h' : 'v',
                    font: {
                            size: legendFontSize,
                            color: '#5c4023'
                        },
                        x: isMobileDevice && deviceOrientation === 'portrait' ? 0.5 : 1.05,
                        y: isMobileDevice && deviceOrientation === 'portrait' ? -0.2 : 1,
                        xanchor: isMobileDevice && deviceOrientation === 'portrait' ? 'center' : 'left',
                        yanchor: isMobileDevice && deviceOrientation === 'portrait' ? 'top' : 'auto'
                    }
                };
                
                if (graphElement._Plotly) {
                    Plotly.purge(graphElement);
                }
                
                console.log('Creating new plot with minimal configuration');
                
                const config = getPlotlyConfig(
                    !isMobileDevice && !isTabletDevice,
                    isMobileDevice,
                    isTabletDevice
                );
                
                Plotly.newPlot(graphElement, traces, layout, config);
                
                const graphSvg = graphElement.querySelector('.main-svg');
                if (graphSvg) {
                    graphSvg.style.backgroundColor = 'rgba(0,0,0,0)';
                }
                const plotArea = graphElement.querySelector('.plotbg');
                if (plotArea) {
                    plotArea.style.fill = 'rgba(242,232,220,0.8)';
                }
            }
        </script>
    </body>
</html>
<!-- Developed by mixbits GitHub: https://github.com/mixbits -->